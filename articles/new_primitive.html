<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Adding a Primitive • anvil</title>
<!-- mathjax math --><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script><script>
  window.MathJax = {
    chtml: {
      fontURL: "https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2"
    }
  };
</script><script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Adding a Primitive">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">anvil</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/anvil.html">Get Started</a></li>
    <li><a class="dropdown-item" href="../articles/type-promotion.html">Type Promotion</a></li>
    <li><a class="dropdown-item" href="../articles/subsetting.html">Subsetting</a></li>
    <li><a class="dropdown-item" href="../articles/random-numbers.html">Random Number Generation</a></li>
    <li><a class="dropdown-item" href="../articles/debugging.html">Debugging</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-examples" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Examples</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-examples">
<li><a class="dropdown-item" href="../articles/logistic-regression.html">Logistic Regression</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-technical" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Technical</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-technical">
<li><a class="dropdown-item" href="../articles/internals.html">Internals</a></li>
    <li><a class="dropdown-item" href="../articles/primitives.html">Primitives Overview</a></li>
    <li><h6 class="dropdown-header" data-toc-skip>Extending</h6></li>
    <li><a class="dropdown-item" href="../articles/contributing.html">Adding a Primitive</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/r-xla/anvil/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Adding a Primitive</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-xla/anvil/blob/main/vignettes/new_primitive.Rmd" class="external-link"><code>vignettes/new_primitive.Rmd</code></a></small>
      <div class="d-none name"><code>new_primitive.Rmd</code></div>
    </div>

    
    
<p>This guide explains how to implement a new primitive. It will
primarily focus on <em>how</em> to do this. See the <a href="internals.html">internals vignette</a> for more information on how
primitives work.</p>
<p>In general, there are two main reasons to add a new primitive:</p>
<ol style="list-style-type: decimal">
<li>The operation is not expressible using existing primitives.</li>
<li>The operation (or, for example, its derivative) would benefit from a
dedicated implementation.</li>
</ol>
<p>In order to be able to add a new primitive, it needs to be
expressible in the <a href="https://github.com/r-xla/stablehlo" class="external-link">{stablehlo}</a> package. There
are various sceanrios:</p>
<ol style="list-style-type: decimal">
<li>The operation is expressible in the StableHLO language and:
<ol style="list-style-type: decimal">
<li>
<p>All required operations are already implemented in the
{stablehlo} R package.</p>
<p><span class="math inline">\(\rightarrow\)</span> This is the simplest
caseand the one we assume in this guide.</p>
</li>
<li>
<p>One or more required operations are not already implemented in
the {stablehlo} R package.</p>
<p><span class="math inline">\(\rightarrow\)</span> You first need to
implement the missing operations in the {stablehlo} R package. See <a href="https://github.com/r-xla/stablehlo/issues/6" class="external-link">this issue</a> for
which operations are missing and the <a href="https://openxla.org/stablehlo/spec" class="external-link">StableHLO specification</a>
for which are available.</p>
</li>
</ol>
</li>
<li>The operation is not available/cannot be efficiently expressed in
StableHLO, because:
<ol style="list-style-type: decimal">
<li>
<p>It requires shape dynamism (output shape depends on data, such as
using boolean values for subsetting):</p>
<p><span class="math inline">\(\rightarrow\)</span> This is currently
not possible, but we hope we can add support for this in the future,
e.g. via a second, dynamic Fortran backend.</p>
</li>
<li>
<p>It cannot be expressed or can only expressed inefficiently:</p>
<p><span class="math inline">\(\rightarrow\)</span> You can implement a
stableHLO custom call, see the custom print operation in <a href="https://github.com/r-xla/pjrt" class="external-link">pjrt</a>. This is currently not
well documented, so you need to dig into the source code.</p>
</li>
</ol>
</li>
</ol>
<div class="section level2">
<h2 id="adding-a-primitive-practical-example">Adding a Primitive: Practical Example<a class="anchor" aria-label="anchor" href="#adding-a-primitive-practical-example"></a>
</h2>
<p>Let’s add a new primitive step by step. We’ll implement
<code>nvl_repeat_along</code> – a primitive that repeats a tensor
multiple times along a specified dimension.</p>
<p>For example, repeating <code>c(1, 2, 3)</code> twice along dimension
1 gives <code>c(1, 2, 3, 1, 2, 3)</code>.</p>
<p>This primitive has a <em>dynamic</em> input (a tensor) and two
<em>static</em> parameters (how many times to repeat and which
dimension).</p>
<div class="section level3">
<h3 id="step-1-create-the-anvilprimitive-object">Step 1: Create the AnvilPrimitive Object<a class="anchor" aria-label="anchor" href="#step-1-create-the-anvilprimitive-object"></a>
</h3>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-xla.github.io/anvil/">anvil</a></span><span class="op">)</span></span>
<span><span class="va">p_repeat_along</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/AnvilPrimitive.html">AnvilPrimitive</a></span><span class="op">(</span><span class="st">"repeat_along"</span><span class="op">)</span></span></code></pre></div>
<p>This is simply the primitive object that will identify this operation
in an <code>AnvilGraph</code> and it will hold the rules for how to
lower it to StableHLO and how to compute gradients.</p>
</div>
<div class="section level3">
<h3 id="step-2-define-the-nvl_-function">Step 2: Define the nvl_* Function<a class="anchor" aria-label="anchor" href="#step-2-define-the-nvl_-function"></a>
</h3>
<p>The <code>nvl_*</code> function does two things:</p>
<ol style="list-style-type: decimal">
<li>Defines an <strong>inference function</strong> that computes output
types from input types</li>
<li>Calls <code><a href="../reference/graph_desc_add.html">graph_desc_add()</a></code> to record the operation in the
current <code>GraphDescriptor</code>.</li>
</ol>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nvl_repeat_along</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">operand</span>, <span class="va">times</span>, <span class="va">dim</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">infer_fn</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">operand</span>, <span class="va">times</span>, <span class="va">dim</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="../reference/is_tensorish.html">is_tensorish</a></span><span class="op">(</span><span class="va">operand</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu">cli</span><span class="fu">::</span><span class="fu"><a href="https://cli.r-lib.org/reference/cli_abort.html" class="external-link">cli_abort</a></span><span class="op">(</span><span class="st">"{.arg operand} must be a tensor-ish object, but is {.cls {class(operand)[1]}}"</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu">checkmate</span><span class="fu">::</span><span class="fu"><a href="https://mllg.github.io/checkmate/reference/checkIntegerish.html" class="external-link">test_integerish</a></span><span class="op">(</span><span class="va">dim</span>, lower <span class="op">=</span> <span class="fl">1</span>, upper <span class="op">=</span> <span class="fu"><a href="https://r-xla.github.io/tengen/reference/ndims.html" class="external-link">ndims</a></span><span class="op">(</span><span class="va">operand</span><span class="op">)</span>, len <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu">cli</span><span class="fu">::</span><span class="fu"><a href="https://cli.r-lib.org/reference/cli_abort.html" class="external-link">cli_abort</a></span><span class="op">(</span><span class="st">"{.arg dim} must be between 1 and {ndims(operand)}, but is {.val dim}"</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu">checkmate</span><span class="fu">::</span><span class="fu"><a href="https://mllg.github.io/checkmate/reference/checkIntegerish.html" class="external-link">test_integerish</a></span><span class="op">(</span><span class="va">times</span>, lower <span class="op">=</span> <span class="fl">1</span>, len <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu">cli_abort</span><span class="op">(</span><span class="st">"times must be a positive integer, but is {times}"</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">new_shape</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-xla.github.io/tengen/reference/shape.html" class="external-link">shape</a></span><span class="op">(</span><span class="va">operand</span><span class="op">)</span></span>
<span>    <span class="va">new_shape</span><span class="op">[</span><span class="va">dim</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">new_shape</span><span class="op">[</span><span class="va">dim</span><span class="op">]</span> <span class="op">*</span> <span class="va">times</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="../reference/AbstractTensor.html">AbstractTensor</a></span><span class="op">(</span></span>
<span>      dtype <span class="op">=</span> <span class="fu"><a href="https://r-xla.github.io/tengen/reference/dtype.html" class="external-link">dtype</a></span><span class="op">(</span><span class="va">operand</span><span class="op">)</span>,</span>
<span>      shape <span class="op">=</span> <span class="fu"><a href="https://r-xla.github.io/stablehlo/reference/Shape.html" class="external-link">Shape</a></span><span class="op">(</span><span class="va">new_shape</span><span class="op">)</span>,</span>
<span>      ambiguous <span class="op">=</span> <span class="va">operand</span><span class="op">$</span><span class="va">ambiguous</span></span>
<span>    <span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="fu"><a href="../reference/graph_desc_add.html">graph_desc_add</a></span><span class="op">(</span></span>
<span>    <span class="va">p_repeat_along</span>,             <span class="co"># The primitive</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>operand <span class="op">=</span> <span class="va">operand</span><span class="op">)</span>,    <span class="co"># Dynamic inputs (tensors)</span></span>
<span>    params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>              <span class="co"># Static parameters</span></span>
<span>      times <span class="op">=</span> <span class="va">times</span>,</span>
<span>      dim <span class="op">=</span> <span class="va">dim</span></span>
<span>    <span class="op">)</span>,</span>
<span>    infer_fn <span class="op">=</span> <span class="va">infer_fn</span></span>
<span>  <span class="op">)</span><span class="op">[[</span><span class="fl">1L</span><span class="op">]</span><span class="op">]</span>  <span class="co"># Extract single output from list</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Key points:</p>
<ul>
<li>The inference function receives abstract tensors (types, not values)
for dynamic inputs, and actual values for static parameters. It must
verify that the arguments to the function are valid. Also, it should
throw clear error messages if the arguments are invalid, as {anvil}
programs are otherwise hard to debug.</li>
<li>
<code><a href="../reference/graph_desc_add.html">graph_desc_add()</a></code> returns a list of outputs; use
<code>[[1L]]</code> for single-output primitives.</li>
<li>Propagate the <code>ambiguous</code> flag from inputs to outputs,
see <a href="type-promotion.html">type promotion</a> for what this
means.</li>
</ul>
<p>If the primitive is a wrapper around a stablehlo operation, it is
possible to use the corresponding inference function from the stablehlo
package (such as <code><a href="https://r-xla.github.io/stablehlo/reference/hlo_concatenate.html" class="external-link">stablehlo::infer_types_concatenate</a></code>). When
doing so, you need to:</p>
<ol style="list-style-type: decimal">
<li>Convert the abstract tensors to stablehlo <code>ValueType</code>s
using <code><a href="../reference/at2vt.html">at2vt()</a></code>.</li>
<li>Call the stablehlo inference function and obtain a list of
<code>ValueType</code>s.</li>
<li>Convert the <code>ValueType</code>s back to abstract tensors using
<code><a href="../reference/vt2at.html">vt2at()</a></code>.</li>
<li>Set the <code>ambiguous</code> flag of the output depending on the
inputs (<code>ambiguity</code> is strictly an {anvil} concept, not a
stablehlo concept).</li>
</ol>
</div>
<div class="section level3">
<h3 id="step-3-add-the-stablehlo-rule">Step 3: Add the StableHLO Rule<a class="anchor" aria-label="anchor" href="#step-3-add-the-stablehlo-rule"></a>
</h3>
<p>The StableHLO rule defines how to lower this primitive to actual
operations, which is used in the <code><a href="../reference/stablehlo.html">stablehlo()</a></code> lowering pass.
We implement <code>repeat_along</code> using concatenation:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p_repeat_along</span><span class="op">[[</span><span class="st">"stablehlo"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">operand</span>, <span class="va">times</span>, <span class="va">dim</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">operands</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">operand</span><span class="op">)</span>, <span class="va">times</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/exec.html" class="external-link">exec</a></span><span class="op">(</span><span class="fu">stablehlo</span><span class="fu">::</span><span class="va"><a href="https://r-xla.github.io/stablehlo/reference/hlo_concatenate.html" class="external-link">hlo_concatenate</a></span>, <span class="op">!</span><span class="op">!</span><span class="op">!</span><span class="va">operands</span>, dimension <span class="op">=</span> <span class="va">dim</span> <span class="op">-</span> <span class="fl">1L</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The rule receives:</p>
<ul>
<li>Dynamic inputs as <code><a href="https://r-xla.github.io/stablehlo/reference/FuncValue.html" class="external-link">stablehlo::FuncValue</a></code>s.</li>
<li>Static parameters as their R values.</li>
</ul>
<p>It must return a list of <code><a href="https://r-xla.github.io/stablehlo/reference/FuncValue.html" class="external-link">stablehlo::FuncValue</a></code>s, even if
there is only one output.</p>
<p><strong>Important</strong>: StableHLO uses 0-based indexing, while
{anvil} uses R’s 1-based indexing. Always convert dimension indices by
subtracting 1. Also note that in <code><a href="../reference/graph_desc_add.html">graph_desc_add()</a></code> we are
converting the error messages from stablehlo to our 1-based indexing, so
you do not have to worry about that here.</p>
</div>
<div class="section level3">
<h3 id="step-4-add-the-backward-rule">Step 4: Add the Backward Rule<a class="anchor" aria-label="anchor" href="#step-4-add-the-backward-rule"></a>
</h3>
<p>If the operation should support automatic differentiation, add a
backward rule. The idea here is the following, where we assume the input
<code>operand</code> has shape <code>(s_1, ..., s_n)</code>, which means
that the output (and therefore it’s gradient) has shape
<code>(s_1, ..., s_{dim-1}, s_dim * times, s_{dim+1}, ..., s_n)</code>.</p>
<ol style="list-style-type: decimal">
<li>Reshape the gradient to
<code>(s_1, ..., s_{dim-1}, s_dim, times, s_{dim+1}, ..., s_n)</code>.</li>
<li>Sum over the <code>times</code> dimension and drop the
<code>times</code> dimension.</li>
</ol>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p_repeat_along</span><span class="op">[[</span><span class="st">"backward"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">inputs</span>, <span class="va">outputs</span>, <span class="va">grads</span>, <span class="va">dim</span>, <span class="va">times</span>, <span class="va">.required</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">.required</span><span class="op">[[</span><span class="fl">1L</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">grad</span> <span class="op">&lt;-</span> <span class="va">grads</span><span class="op">[[</span><span class="fl">1L</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">operand</span> <span class="op">&lt;-</span> <span class="va">inputs</span><span class="op">[[</span><span class="fl">1L</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span>  <span class="va">old_shape</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-xla.github.io/tengen/reference/shape.html" class="external-link">shape</a></span><span class="op">(</span><span class="va">operand</span><span class="op">)</span></span>
<span>  <span class="va">grad_shape</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-xla.github.io/tengen/reference/shape.html" class="external-link">shape</a></span><span class="op">(</span><span class="va">grad</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">new_shape</span> <span class="op">&lt;-</span> <span class="va">grad_shape</span></span>
<span>  <span class="va">new_shape</span><span class="op">[</span><span class="va">dim</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">old_shape</span><span class="op">[</span><span class="va">dim</span><span class="op">]</span></span>
<span>  <span class="va">new_shape</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/append.html" class="external-link">append</a></span><span class="op">(</span><span class="va">new_shape</span>, <span class="va">times</span>, after <span class="op">=</span> <span class="va">dim</span> <span class="op">-</span> <span class="fl">1L</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">grad_reshaped</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nvl_reshape.html">nvl_reshape</a></span><span class="op">(</span><span class="va">grad</span>, <span class="va">new_shape</span><span class="op">)</span></span>
<span>  <span class="va">grad_summed</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nvl_reduce_sum.html">nvl_reduce_sum</a></span><span class="op">(</span><span class="va">grad_reshaped</span>, dims <span class="op">=</span> <span class="va">dim</span>, drop <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">grad_summed</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The backward rule receives:</p>
<ul>
<li>
<code>inputs</code>: Input <code>GraphValue</code>s from the forward
pass</li>
<li>
<code>outputs</code>: Output <code>GraphValue</code>s from the
forward pass</li>
<li>
<code>grads</code>: Gradients flowing back from downstream (one per
output)</li>
<li>Static parameters by name (here: <code>dim</code>,
<code>times</code>)</li>
<li>
<code>.required</code>: Logical vector indicating which input
gradients are needed</li>
</ul>
<p>It returns a list with one gradient per input (or <code>NULL</code>
if not required).</p>
</div>
</div>
<div class="section level2">
<h2 id="step-5-register-the-primitive">Step 5: Register the Primitive<a class="anchor" aria-label="anchor" href="#step-5-register-the-primitive"></a>
</h2>
<p>To not pollute the global namespace, the primitive objects
(<code>p_repeat_along</code> in our case) are not exported. Instead,
they can be retrieved via <code>prim("repeat_along")</code>. To make
this work, you need to register the primitive object:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/register_primitive.html">register_primitive</a></span><span class="op">(</span><span class="st">"repeat_along"</span>, <span class="va">p_repeat_along</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/prim.html">prim</a></span><span class="op">(</span><span class="st">"repeat_along"</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;AnvilPrimitive:repeat_along&gt;</span></span></code></pre></div>
<div class="section level3">
<h3 id="step-6-add-an-nv_-api-function">Step 6: Add an <code>nv_</code> API Function<a class="anchor" aria-label="anchor" href="#step-6-add-an-nv_-api-function"></a>
</h3>
<p>In {anvil}, we also offer convenience wrappers around the primitives.
An example is <code>nvl_add</code> vs <code>nv_add</code>, where the
latter calls into the former after optionally broadcasting (scalar)
inputs:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/nv_add.html">nv_add</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="../reference/AnvilTensor.html">nv_tensor</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; f32?{2}</span></span>
<span><span class="fu"><a href="../reference/nvl_add.html">nvl_add</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="../reference/AnvilTensor.html">nv_tensor</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `nvl_add()`:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> `lhs` and `rhs` must have the same tensor type.</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> Got <span style="color: #0000BB;">tensor&lt;f32&gt;</span> and <span style="color: #0000BB;">tensor&lt;2xi32&gt;</span>.</span></span></code></pre></div>
<p>In our case, no such convenience is needed and the functionality is
not too low-level (for it to be generally useful), so we can just
reassign the <code>nvl_*</code> function to an <code>nv_*</code>
function:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nv_repeat_along</span> <span class="op">&lt;-</span> <span class="va">nvl_repeat_along</span></span></code></pre></div>
<p>Note that in the <code>nv_*</code> wrapper function, you can only
access certain properties of the input tensorish values via:</p>
<ul>
<li><code><a href="../reference/abstract_properties.html">shape_abstract()</a></code></li>
<li><code><a href="../reference/abstract_properties.html">ndims_abstract()</a></code></li>
<li><code><a href="../reference/abstract_properties.html">dtype_abstract()</a></code></li>
<li><code><a href="../reference/abstract_properties.html">ambiguous_abstract()</a></code></li>
</ul>
<p>If you, for example, use <code><a href="https://r-xla.github.io/tengen/reference/shape.html" class="external-link">shape()</a></code> instead of
<code><a href="../reference/abstract_properties.html">shape_abstract()</a></code>, your function won’t work with R literals.
I.e., <code>&lt;extract&gt;_abstract()</code> first converts the input
to an <code>AbstractTensor</code> (if possible) and then extracts the
property.</p>
</div>
<div class="section level3">
<h3 id="using-your-primitive">Using Your Primitive<a class="anchor" aria-label="anchor" href="#using-your-primitive"></a>
</h3>
<p>You can now use the primitive:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/AnvilTensor.html">nv_tensor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span>, shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/jit.html">jit</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">nvl_repeat_along</span><span class="op">(</span><span class="va">x</span>, times <span class="op">=</span> <span class="fl">2L</span>, dim <span class="op">=</span> <span class="fl">2L</span><span class="op">)</span><span class="op">)</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="va">result</span></span>
<span><span class="co">#&gt; AnvilTensor</span></span>
<span><span class="co">#&gt;  1 1</span></span>
<span><span class="co">#&gt;  2 2</span></span>
<span><span class="co">#&gt;  3 3</span></span>
<span><span class="co">#&gt; [ CPUf32{3,2} ]</span></span></code></pre></div>
<p>And compute gradients through it.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">f</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">repeated</span> <span class="op">&lt;-</span> <span class="fu">nvl_repeat_along</span><span class="op">(</span><span class="va">x</span>, times <span class="op">=</span> <span class="fl">2L</span>, dim <span class="op">=</span> <span class="fl">2L</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">repeated</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">grad_f</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/jit.html">jit</a></span><span class="op">(</span><span class="fu"><a href="../reference/gradient.html">gradient</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">grad_f</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">[[</span><span class="fl">1L</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; AnvilTensor</span></span>
<span><span class="co">#&gt;  2</span></span>
<span><span class="co">#&gt;  2</span></span>
<span><span class="co">#&gt;  2</span></span>
<span><span class="co">#&gt; [ CPUf32{3,1} ]</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="contributing-to-the-package">Contributing to the Package<a class="anchor" aria-label="anchor" href="#contributing-to-the-package"></a>
</h2>
<p>If you want to contribute your primitive to {anvil}, there are some
additional things to be aware of.</p>
<div class="section level3">
<h3 id="file-organization">File Organization<a class="anchor" aria-label="anchor" href="#file-organization"></a>
</h3>
<ul>
<li>
<strong><code>R/primitives.R</code></strong>: Define
<code>AnvilPrimitive</code> object and <code>nvl_*</code> function</li>
<li>
<strong><code>R/rules-stablehlo.R</code></strong>: Add the StableHLO
lowering rule</li>
<li>
<strong><code>R/rules-backward.R</code></strong>: Add the backward
rule (if differentiable)</li>
<li>
<strong><code>R/api.R</code></strong>: Add the <code>nv_*</code>
wrapper function (or possibly in another <strong>api</strong>
file).</li>
</ul>
</div>
<div class="section level3">
<h3 id="testing">Testing<a class="anchor" aria-label="anchor" href="#testing"></a>
</h3>
<p>Tests can go in two places:</p>
<ol style="list-style-type: decimal">
<li>
<strong><code>inst/extra-tests/</code></strong>: For tests that
compare against torch. These live in <code>inst/</code> to avoid listing
torch as a dependency.</li>
<li>
<strong><code>tests/testthat/</code></strong>: For tests without a
torch counterpart.</li>
</ol>
<p><strong>Important</strong>: Test names must start with
<code>"p_&lt;name&gt;"</code> (matching the primitive object name). The
meta tests verify that every primitive has corresponding tests.</p>
<p>Since no torch counterpart exists for <code>nvl_repeat_along</code>,
we would add manual tests in:</p>
<ul>
<li><code>tests/testthat/test-primitives-stablehlo.R</code></li>
<li><code>tests/testthat/test-primitives-backward.R</code></li>
</ul>
<p>Also, ensure that no linter errors are present,
<code>devtools::check()</code> passes, and format the code using
<code>make format</code>.</p>
</div>
</div>
<div class="section level2">
<h2 id="higher-order-primitives">Higher-Order Primitives<a class="anchor" aria-label="anchor" href="#higher-order-primitives"></a>
</h2>
<p>Higher-Order Primitives are primitives that parameterized by an R
function or expression. Examples include <code>nvl_if</code> and
<code>nvl_while</code>. These are generally much more complex to handle,
so we don’t cover them here in detail (for now). The general idea,
however, is that the primitive <code>nvl_*</code> function needs to
trace the provided function using <code><a href="../reference/trace_fn.html">trace_fn()</a></code> and then
forward this graph to the stablehlo lowering rule and backward rule.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Sebastian Fischer, Daniel Falbel, Nikolai German.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
